<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rental Statistic (FARHA CAR)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #e9ecef;
        }
        header {
            background: #343a40;
            color: white;
            padding: 15px 0;
            text-align: center;
            border-radius: 5px;
        }
        h2 {
            margin: 20px 0;
            font-size: 1.2em;
            color: #343a40;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #007BFF;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #d1ecf1;
        }
        footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9em;
            color: #6c757d;
        }
        .highlight {
            background-color: #ffcccc;
        }
        table.client tbody tr {
            background-color: white;
        }
        table.client tbody tr.highlight {
            background-color: #ffcccc; /* Highlight color for 'Not Returned' status */
        }
        table.client tbody tr:hover {
            background-color: #d1ecf1;
        }
        input[type="date"] {
            width: 80%;
            padding: 10px;
            border: 2px solid #4CAF50;
            border-radius: 5px;
            font-size: 16px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            transition: border-color 0.3s;
        }
        input[type="date"]:focus {
            border-color: #45a049;
        }
        .payment-status {
            padding: 10px;
            background-color: #f0f8ff; /* Light blue background */
            border: 2px solid #4CAF50; /* Green border */
            border-radius: 5px; /* Rounded corners */
            font-size: 16px; /* Larger font size */
            color: #333; /* Dark text color */
            transition: border-color 0.3s; /* Smooth border color transition */
        }

        .payment-status:focus {
            border-color: #007BFF; /* Change border color on focus */
            outline: none; /* Remove default outline */
        }
        @media print {
            #printButton {
                display: none !important;
            }
            button[onclick="printPage()"] {
                display: none; /* Hide the print button when printing */
            }
            .delete-column {
                display: none; /* Hide the delete column when printing */
            }
            #expenseForm, #addExpenseButton {
                display: none;
            }
            #expenseTable th:last-child,
            #expenseTable td:last-child {
                display: none;
            }
            #clientForm, button[type="submit"] {
                display: none;
            }
            /* Hide elements during printing */
            #clearAllDataBtn,
            #balanceAddForm,
            .delete-btn,
            .delete-column,
            .balance-add th:last-child,
            .balance-add td:last-child,
            .client th:nth-last-child(2),  /* Hide Payment Status header */
            .client td:nth-last-child(2) { /* Hide Payment Status column */
                display: none !important;
            }
            
            /* Ensure good print layout */
            body {
                padding: 20px;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            thead {
                display: table-header-group;
            }
            
            tfoot {
                display: table-footer-group;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Rental Journalier (FARHA CAR)</h1>
    </header>
    <main>
        <section id="statistics">
            <button id="printButton" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); margin-top: 20px; margin-bottom: 10px;">Print</button>
            <button onclick="clearAllData()" id="clearAllDataBtn" style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); margin-top: 20px; margin-bottom: 10px; margin-left: 10px;">Clear All Data</button>
            <h2>Balance Add</h2>
            <form id="balanceAddForm" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <input type="date" id="balanceDate" required style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; flex: 1;">
                <select id="balanceMotif" required style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; flex: 1;">
                    <option value="" disabled selected>Select a Motif</option>
                    <option value="Balance precedent">Balance precedent</option>
                    <option value="Regalement de Facture">Regalement de Facture</option>
                    <option value="Emprunt d'argent">Emprunt d'argent</option>
                    <option value="Autre">Autre</option>
                </select>
                <input type="text" id="balanceComment" placeholder="Comment" required style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; flex: 1;">
                <input type="number" id="balanceAmount" placeholder="Balance Amount" required style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; flex: 1;">
                <button type="submit" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.3s;">Add Balance</button>
            </form>
            <table class="balance-add" style="width: 100%; border-collapse: collapse; margin-bottom: 30px; background-color: #f9f9f9;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Date</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Motif</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Comment</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Balance</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Action</th>
                    </tr>
                </thead>
                <tbody id="balanceAddTableBody">
                </tbody>
            </table>
            <h2>Client Activity</h2>
            <form id="clientForm">
                <input type="text" name="fullName" placeholder="Full Name" required style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; width: 100%; max-width: 300px; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); transition: border-color 0.3s; margin-bottom: 10px;" onfocus="this.style.borderColor='#45a049';" onblur="this.style.borderColor='#4CAF50';" />
                <input type="text" name="clientID" placeholder="Client ID (NIN)" required style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; width: 100%; max-width: 300px; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); transition: border-color 0.3s; margin-bottom: 10px;" onfocus="this.style.borderColor='#45a049';" onblur="this.style.borderColor='#4CAF50';" />
                <input type="text" name="phoneNumber" placeholder="Phone Number" required style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; width: 100%; max-width: 300px; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); transition: border-color 0.3s; margin-bottom: 10px;" onfocus="this.style.borderColor='#45a049';" onblur="this.style.borderColor='#4CAF50';" />
                <input type="text" name="vehicleModel" placeholder="Vehicle Maker & Model" required style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; width: 100%; max-width: 300px; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); transition: border-color 0.3s; margin-bottom: 10px;" onfocus="this.style.borderColor='#45a049';" onblur="this.style.borderColor='#4CAF50';" />
                <input type="text" name="vehiclePlate" placeholder="Vehicle Plate" required style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; width: 100%; max-width: 300px; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); transition: border-color 0.3s; margin-bottom: 10px;" onfocus="this.style.borderColor='#45a049';" onblur="this.style.borderColor='#4CAF50';" />
                <input type="date" name="pickupDate" required style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; width: 100%; max-width: 300px; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); transition: border-color 0.3s; margin-bottom: 10px;" onfocus="this.style.borderColor='#45a049';" onblur="this.style.borderColor='#4CAF50';" />
                <input type="date" name="returnDate" required style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; width: 100%; max-width: 300px; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); transition: border-color 0.3s; margin-bottom: 10px;" onfocus="this.style.borderColor='#45a049';" onblur="this.style.borderColor='#4CAF50';" />
                <input type="number" name="pricePerDay" placeholder="Price Per Day" required style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; width: 100%; max-width: 300px; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); transition: border-color 0.3s; margin-bottom: 10px;" onfocus="this.style.borderColor='#45a049';" onblur="this.style.borderColor='#4CAF50';" />
                <button type="submit" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); margin-top: 10px;">Add Client</button>
            </form>
            <table class="client" style="width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #f9f9f9;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Full Name</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Client ID (NIN)</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Phone Number</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Vehicle Model</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Vehicle Plate</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Pickup Date</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Return Date</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Price Per Day</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Total Price</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Status</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Payment Status</th>
                        <th class="delete-column" style="border: 1px solid #4CAF50; padding: 8px;">Delete</th>
                    </tr>
                </thead>
                <tbody id="clientTable">
                    <!-- Client data will be populated here -->
                </tbody>
            </table>
            <div id="totalIncomeContainer" style="margin-top: 20px; text-align: right; font-size: 20px;">
                <strong>Total Income:</strong> <span id="totalIncome">0 KMF</span>
            </div>
            <h2>Monthly Income</h2>
            <table class="monthlyincome" style="width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #f9f9f9;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Year</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Month</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Total Income</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px;">Client Number</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Monthly income data will be populated here -->
                </tbody>
            </table>
            <h2>Customer Ranking</h2>
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #f9f9f9;">
                <thead style="background-color: #f8f9fa;">
                    <tr>
                        <th style="border: 1px solid #4CAF50; padding: 8px; text-align: left;">Rank</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px; text-align: left;">Full Name</th>
                        <th style="border: 1px solid #4CAF50; padding: 8px; text-align: left;">Number of Rentals</th>
                    </tr>
                </thead>
                <tbody id="customerRankingBody"></tbody>
            </table>
            <h2>Expense Report</h2>
            <div id="expenseForm">
                <input type="date" id="expenseDate" style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; width: 100%; max-width: 300px; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); transition: border-color 0.3s; margin-right: 5px;" />
                <select id="expenseMotif" style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; width: 100%; max-width: 300px; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); transition: border-color 0.3s; margin-right: 5px;">
                    <option value="" disabled selected>Select a Motif</option>
                    <option value="Versement Exim">Versement Exim</option>
                    <option value="Achat de nouveau produit">Achat de nouveau produit</option>
                    <option value="Paiement de facture">Paiement de facture</option>
                    <option value="Autre">Autre</option>
                </select>
                <input type="text" id="expenseComment" placeholder="Comment" style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; width: 100%; max-width: 300px; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); transition: border-color 0.3s; margin-right: 5px;" />
                <input type="number" id="expensePrice" placeholder="Price" required style="padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; font-size: 16px; width: 100%; max-width: 300px; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); transition: border-color 0.3s; margin-right: 5px;" />
                <button id="addExpenseButton" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); margin-top: 10px;">Add Expense</button>
            </div>
            <table id="expenseTable" border="1">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Motif</th>
                        <th>Comment</th>
                        <th>Price</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3">Total Expense:</td>
                        <td id="totalExpense" style="font-size: 18px; font-weight: bold;">0 KMF</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
            <h2>Summary</h2>
            <table id="summaryTable" border="1" style="margin-top: 20px;">
                <thead>
                    <tr>
                        <th>Printed Date</th>
                        <th>Total Restant</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="printedDate">N/A</td>
                        <td id="summaryTotalRestant">0 KMF</td>
                    </tr>
                </tbody>
            </table>
            <script>
                var total = 0;
                document.getElementById('addExpenseButton').onclick = function() {
                    var date = document.getElementById('expenseDate').value;
                    var motif = document.getElementById('expenseMotif').value;
                    var comment = document.getElementById('expenseComment').value;
                    var price = document.getElementById('expensePrice').value;

                    // Check if price is a valid number
                    if (isNaN(price) || price.trim() === '') {
                        alert('Please enter a valid price.');
                        return;
                    }

                    // Format the price with commas and append 'KMF'
                    var formattedPrice = parseFloat(price).toLocaleString('en-US') + ' KMF';

                    // Update total expense
                    total += parseFloat(price);
                    document.getElementById('totalExpense').innerText = total.toLocaleString('en-US') + ' KMF';

                    var table = document.getElementById('expenseTable').getElementsByTagName('tbody')[0];
                    var newRow = table.insertRow();

                    newRow.insertCell(0).innerText = date;
                    newRow.insertCell(1).innerText = motif;
                    newRow.insertCell(2).innerText = comment;
                    newRow.insertCell(3).innerText = formattedPrice;
                    newRow.insertCell(4).innerHTML = '<button style="background-color: red; color: white; border: none; border-radius: 5px; cursor: pointer;">Delete</button>';

                    // Clear input fields after adding
                    document.getElementById('expenseDate').value = '';
                    document.getElementById('expenseMotif').value = '';
                    document.getElementById('expenseComment').value = '';
                    document.getElementById('expensePrice').value = '';

                    // Add delete button functionality
                    newRow.querySelector('button').onclick = function() {
                        const row = this.parentNode.parentNode;
                        row.parentNode.removeChild(row);
                        updateTotalExpense(); // Update total expense after deletion
                        updateTotalRestant(); // Update total restant after deletion
                    };

                    // Update total restant after adding expense
                    updateTotalRestant();
                };

                function updateTotalExpense() {
                    let total = 0;
                    const rows = document.querySelectorAll('#expenseTable tbody tr');
                    rows.forEach(row => {
                        const priceCell = row.cells[3]; // Assuming the price is in the fourth column
                        const price = parseFloat(priceCell.innerText.replace(/ KMF/, '').replace(/,/g, ''));
                        if (!isNaN(price)) {
                            total += price;
                        }
                    });
                    document.getElementById('totalExpense').innerText = total.toLocaleString('en-US') + ' KMF';
                }

                function updateTotalRestant() {
                    const totalIncome = parseFloat(document.getElementById('totalIncome').innerText.replace(/ KMF/, '').replace(/,/g, ''));
                    const totalExpense = parseFloat(document.getElementById('totalExpense').innerText.replace(/ KMF/, '').replace(/,/g, ''));
                    const totalRestant = totalIncome - totalExpense;
                    document.getElementById('summaryTotalRestant').innerText = totalRestant.toLocaleString('en-US') + ' KMF';
                }
            </script>
            <script>
                document.getElementById('expenseMotif').onchange = function() {
                    var commentInput = document.getElementById('expenseComment');
                    if (this.value === 'Versement Exim') {
                        commentInput.placeholder = 'Account Number';
                    } else if (this.value === 'Paiement de facture') {
                        commentInput.placeholder = 'Description';
                    } else {
                        commentInput.placeholder = 'Comment';
                    }
                };
            </script>
            <script>
                // Function to extract data from the table
                function getTableData() {
                const prices = [];
                const rows = document.querySelectorAll('#statistics table.client tbody tr');
                let totalIncome = 0;

                rows.forEach(row => {
                    const paymentStatus = row.querySelector('.payment-status').value; // Get the payment status
                    if (paymentStatus === 'not-paid') {
                        totalPrice = 0; // Set total price to 0 if not paid
                    } else {
                        const priceCell = row.cells[8].textContent.replace(' KMF', '').replace(/,/g, ''); // Get price and remove ' KMF'
                        const priceValue = parseFloat(priceCell); // Convert to number

                        console.log('Raw price value:', priceCell); // Debugging log

                        if (!isNaN(priceValue)) { // Check if priceValue is a valid number
                            totalIncome += priceValue; // Add to total income
                            prices.push(priceValue); // Store price for further use
                        } else {
                            console.error('Invalid price value:', priceCell); // Log invalid price
                        }
                    }
                });

                return { prices, totalIncome };
            }

                const { prices, totalIncome } = getTableData();
                const totalIncomeLabel = document.getElementById('totalIncome');
                totalIncomeLabel.textContent = `${totalIncome} KMF`;
            </script>
            <script>
                // Function to update status based on return date and current date
                function updateStatusOnDateChange() {
                    const rows = document.querySelectorAll('#statistics table.client tbody tr');
                    const currentDate = new Date('2025-01-05T19:39:35+03:00'); // Updated current date
                    rows.forEach(row => {
                        const returnDateInput = row.cells[6].querySelector('input[type="date"]');
                        const returnDate = new Date(returnDateInput.value);
                        const statusCell = row.cells[9].querySelector('.status');

                        if (returnDate <= currentDate) {
                            statusCell.textContent = 'Returned';
                            row.classList.remove('highlight');
                        } else {
                            statusCell.textContent = 'Not Returned';
                            row.classList.add('highlight');
                        }
                    });
                }

                // Attach event listener to return date inputs
                document.querySelectorAll('input[type="date"]').forEach(input => {
                    input.addEventListener('change', updateStatusOnDateChange);
                });
                updateStatusOnDateChange(); // Initial update
            </script>
            <script>
                // Function to format number with commas
                function formatNumberWithCommas(x) {
                    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                }

                // Function to update price based on price per day and rental duration
                function updatePrice() {
                    const rows = document.querySelectorAll('#statistics table.client tbody tr');
                    rows.forEach(row => {
                        const pickupDate = new Date(row.cells[5].textContent.split('/').reverse().join('-')); // Convert to Date object
                        const returnDateInput = row.cells[6].querySelector('input[type="date"]');
                        const returnDate = new Date(returnDateInput.value);
                        const pricePerDayInput = row.cells[7].querySelector('input[type="number"]');
                        const pricePerDay = parseFloat(pricePerDayInput.value);

                        const paymentStatus = row.querySelector('.payment-status').value; // Get the payment status
                        let totalPrice;
                        if (paymentStatus === 'not-paid') {
                            totalPrice = 0; // Set total price to 0 if not paid
                        } else {
                            const timeDiff = returnDate - pickupDate;
                            const daysRented = Math.ceil(timeDiff / (1000 * 3600 * 24)); // Convert milliseconds to days
                            totalPrice = daysRented * pricePerDay;
                        }

                        row.cells[8].textContent = formatNumberWithCommas(totalPrice) + ' KMF'; // Update price cell

                    });
                    updateTotalIncome(); // Update total income
                }

                // Function to update total income based on prices in the table
                function updateTotalIncome() {
                    const rows = document.querySelectorAll('#statistics table.client tbody tr');
                    let totalIncome = 0;
                    rows.forEach(row => {
                        const paymentStatus = row.querySelector('.payment-status').value; // Get the payment status
                        if (paymentStatus === 'not-paid') {
                            totalPrice = 0; // Set total price to 0 if not paid
                        } else {
                            const priceCell = row.cells[8].textContent.replace(' KMF', '').replace(/,/g, ''); // Get price and remove ' KMF'
                            totalIncome += parseFloat(priceCell) || 0; // Add to total income
                        }
                    });
                    const totalIncomeLabel = document.getElementById('totalIncome');
                    totalIncomeLabel.textContent = `${formatNumberWithCommas(totalIncome)} KMF`;
                    console.log('Total Income Updated:', totalIncome); // Debugging statement
                    updateTotalRestant(); // Update total restant
                }

                // Attach event listeners to price per day and return date inputs
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    input.addEventListener('change', updatePrice);
                });
                document.querySelectorAll('input[type="date"]').forEach(input => {
                    input.addEventListener('change', updatePrice);
                });
                updatePrice(); // Initial update
            </script>
            <script>
                // Function to calculate monthly income
                function calculateMonthlyIncome() {
                    const clientTable = document.querySelector('.client tbody');
                    const monthlyIncomeTable = document.querySelector('.monthlyincome tbody');
                    const rows = clientTable.querySelectorAll('tr');
                    const monthlyData = {};

                    // Process each client row
                    rows.forEach(row => {
                        const pickupDate = new Date(row.cells[5].textContent);
                        const paymentStatus = row.querySelector('.payment-status').value;
                        let price = 0;
                        
                        if (paymentStatus === 'paid' || paymentStatus === 'Paid') {
                            const priceText = row.cells[8].textContent;
                            price = parseFloat(priceText.replace(/[^\d.-]/g, '')); // Remove non-numeric characters
                        }

                        if (!isNaN(price)) {
                            const year = pickupDate.getFullYear();
                            const month = pickupDate.toLocaleString('default', { month: 'long' });
                            const key = `${year}-${month}`;

                            if (!monthlyData[key]) {
                                monthlyData[key] = {
                                    year: year,
                                    month: month,
                                    totalIncome: 0,
                                    clientCount: 0,
                                    averagePerClient: 0
                                };
                            }

                            monthlyData[key].totalIncome += price;
                            monthlyData[key].clientCount += 1;
                        }
                    });

                    // Calculate averages and sort data
                    const sortedData = Object.values(monthlyData)
                        .map(data => {
                            data.averagePerClient = data.clientCount > 0 
                                ? data.totalIncome / data.clientCount 
                                : 0;
                            return data;
                        })
                        .sort((a, b) => {
                            // Sort by year descending
                            if (b.year !== a.year) return b.year - a.year;
                            // Then by month (using month index for proper sorting)
                            const monthsOrder = ['January', 'February', 'March', 'April', 'May', 'June', 
                                              'July', 'August', 'September', 'October', 'November', 'December'];
                            return monthsOrder.indexOf(b.month) - monthsOrder.indexOf(a.month);
                        });

                    // Clear and populate the monthly income table
                    monthlyIncomeTable.innerHTML = '';
                    let totalAnnualIncome = 0;
                    let currentYear = null;

                    sortedData.forEach(data => {
                        if (currentYear !== data.year && currentYear !== null) {
                            // Add annual summary row
                            const annualRow = document.createElement('tr');
                            annualRow.innerHTML = `
                                <td colspan="2" style="background-color: #f8f9fa; font-weight: bold;">Annual Total ${currentYear}</td>
                                <td style="background-color: #f8f9fa; font-weight: bold;">${formatNumberWithCommas(totalAnnualIncome)} KMF</td>
                                <td style="background-color: #f8f9fa;"></td>
                            `;
                            monthlyIncomeTable.appendChild(annualRow);
                            totalAnnualIncome = 0;
                        }

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${data.year}</td>
                            <td>${data.month}</td>
                            <td>${formatNumberWithCommas(data.totalIncome)} KMF</td>
                            <td>${data.clientCount}</td>
                        `;
                        monthlyIncomeTable.appendChild(row);

                        currentYear = data.year;
                        totalAnnualIncome += data.totalIncome;
                    });

                    // Add the last annual summary row
                    if (currentYear !== null && totalAnnualIncome > 0) {
                        const annualRow = document.createElement('tr');
                        annualRow.innerHTML = `
                            <td colspan="2" style="background-color: #f8f9fa; font-weight: bold;">Annual Total ${currentYear}</td>
                            <td style="background-color: #f8f9fa; font-weight: bold;">${formatNumberWithCommas(totalAnnualIncome)} KMF</td>
                            <td style="background-color: #f8f9fa;"></td>
                        `;
                        monthlyIncomeTable.appendChild(annualRow);
                    }
                }

                // Call calculateMonthlyIncome when needed (after adding/updating/deleting clients)
                // This is already being called in the appropriate places
            </script>
            <script>
                // Function to save client data to local storage
                function saveClientData(clientData) {
                    const clients = JSON.parse(localStorage.getItem('clientData')) || [];
                    clients.push(clientData);
                    localStorage.setItem('clientData', JSON.stringify(clients));
                    // Update customer ranking after adding new client
                    updateCustomerRanking();
                }

                // Function to delete client from storage
                function deleteClientFromStorage(clientToDelete) {
                    const clients = JSON.parse(localStorage.getItem('clientData')) || [];
                    const filteredClients = clients.filter(client => 
                        !(client.clientID === clientToDelete.clientID && 
                          client.fullName === clientToDelete.fullName)
                    );
                    localStorage.setItem('clientData', JSON.stringify(filteredClients));
                    // Update customer ranking after deleting client
                    updateCustomerRanking();
                }

                // Function to update a client in localStorage
                function updateClientInStorage(updatedClient) {
                    const clients = JSON.parse(localStorage.getItem('clientData')) || [];
                    const index = clients.findIndex(client => 
                        client.clientID === updatedClient.clientID && 
                        client.fullName === updatedClient.fullName
                    );
                    if (index !== -1) {
                        clients[index] = updatedClient;
                        localStorage.setItem('clientData', JSON.stringify(clients));
                        // Update customer ranking after updating client
                        updateCustomerRanking();
                    }
                }
            </script>
            <script>
                // Function to load client data from local storage
                function loadClientData() {
                    const clients = JSON.parse(localStorage.getItem('clientData')) || [];
                    const clientTableBody = document.querySelector('#statistics table.client tbody');
                    clientTableBody.innerHTML = ''; // Clear existing rows

                    clients.forEach(client => {
                        const newRow = document.createElement('tr');
                        newRow.innerHTML = `
                            <td>${client.fullName}</td>
                            <td>${client.clientID}</td>
                            <td>${client.phoneNumber}</td>
                            <td>${client.vehicleModel}</td>
                            <td>${client.vehiclePlate}</td>
                            <td>${client.pickupDate}</td>
                            <td><input type="date" value="${client.returnDate}" /></td>
                            <td>${formatNumberWithCommas(client.pricePerDay)} KMF</td>
                            <td>${formatNumberWithCommas(client.totalPrice)} KMF</td>
                            <td><span class="status">${client.status}</span></td>
                            <td><select class='payment-status'>
                                <option value='paid' ${client.paymentStatus === 'paid' ? 'selected' : ''}>Paid</option>
                                <option value='not-paid' ${client.paymentStatus === 'not-paid' ? 'selected' : ''}>Not Paid</option>
                            </select></td>
                            <td class="delete-column">
                                <button class="deleteBtn" style="background-color: red; color: white; border: none; border-radius: 5px; cursor: pointer;">Delete</button>
                            </td>
                        `;

                        // Add event listeners
                        addRowEventListeners(newRow, client);
                        
                        // Add highlighting if needed
                        if (client.status === 'Not Returned') {
                            newRow.classList.add('highlight');
                        }

                        clientTableBody.appendChild(newRow);
                    });

                    // Update calculations
                    updateTotalIncome();
                    calculateMonthlyIncome();
                    calculateCustomerRanking();
                }

                // Function to add event listeners to a row
                function addRowEventListeners(row, clientData) {
                    // Return date change listener
                    const returnDateInput = row.cells[6].querySelector('input[type="date"]');
                    returnDateInput.addEventListener('change', function() {
                        const pickupDate = new Date(clientData.pickupDate);
                        const returnDate = new Date(this.value);
                        const pricePerDay = clientData.pricePerDay;
                        const paymentStatus = row.querySelector('.payment-status').value;
                        
                        let totalPrice;
                        if (paymentStatus === 'not-paid') {
                            totalPrice = 0;
                        } else {
                            const timeDiff = returnDate - pickupDate;
                            const daysRented = Math.ceil(timeDiff / (1000 * 3600 * 24));
                            totalPrice = daysRented * pricePerDay;
                        }

                        // Update row and client data
                        row.cells[8].textContent = formatNumberWithCommas(totalPrice) + ' KMF';
                        const statusCell = row.querySelector('.status');
                        const currentDate = new Date('2025-01-14T11:45:06+03:00');
                        
                        if (returnDate <= currentDate) {
                            statusCell.textContent = 'Returned';
                            row.classList.remove('highlight');
                            clientData.status = 'Returned';
                        } else {
                            statusCell.textContent = 'Not Returned';
                            row.classList.add('highlight');
                            clientData.status = 'Not Returned';
                        }

                        // Update client data in localStorage
                        clientData.returnDate = this.value;
                        clientData.totalPrice = totalPrice;
                        updateClientInStorage(clientData);

                        // Update calculations
                        updateTotalIncome();
                        calculateMonthlyIncome();
                        calculateCustomerRanking();
                    });

                    // Payment status change listener
                    const paymentStatusSelect = row.querySelector('.payment-status');
                    paymentStatusSelect.addEventListener('change', function() {
                        const paymentStatus = this.value;
                        const pickupDate = new Date(clientData.pickupDate);
                        const returnDate = new Date(returnDateInput.value);
                        const pricePerDay = clientData.pricePerDay;
                        
                        let totalPrice;
                        if (paymentStatus === 'not-paid') {
                            totalPrice = 0;
                        } else {
                            const timeDiff = returnDate - pickupDate;
                            const daysRented = Math.ceil(timeDiff / (1000 * 3600 * 24));
                            totalPrice = daysRented * pricePerDay;
                        }

                        // Update row and client data
                        row.cells[8].textContent = formatNumberWithCommas(totalPrice) + ' KMF';
                        clientData.paymentStatus = paymentStatus;
                        clientData.totalPrice = totalPrice;
                        updateClientInStorage(clientData);

                        // Update calculations
                        updateTotalIncome();
                    });

                    // Delete button listener
                    const deleteBtn = row.querySelector('.deleteBtn');
                    deleteBtn.addEventListener('click', function() {
                        if (confirm('Are you sure you want to delete this entry? This action cannot be undone.')) {
                            deleteClientFromStorage(clientData);
                            row.remove();
                            updateTotalIncome();
                            calculateMonthlyIncome();
                            calculateCustomerRanking();
                        }
                    });
                }

                // Function to update customer ranking table
                function updateCustomerRanking() {
                    const clientData = JSON.parse(localStorage.getItem('clientData')) || [];
                    const customerFrequency = {};
                    
                    // Count rental frequency for each customer
                    clientData.forEach(client => {
                        const fullName = client.fullName;
                        if (fullName) { // Make sure we have a valid name
                            customerFrequency[fullName] = (customerFrequency[fullName] || 0) + 1;
                        }
                    });

                    // Convert to array and sort by frequency
                    const sortedCustomers = Object.entries(customerFrequency)
                        .map(([name, frequency]) => ({ name, frequency }))
                        .sort((a, b) => b.frequency - a.frequency);

                    // Update the table
                    const rankingTableBody = document.getElementById('customerRankingBody');
                    rankingTableBody.innerHTML = ''; // Clear existing rows

                    if (sortedCustomers.length === 0) {
                        // If no customers, show a message
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="3" style="border: 1px solid #4CAF50; padding: 8px; text-align: center;">No customer data available</td>
                        `;
                        rankingTableBody.appendChild(row);
                    } else {
                        // Show customer rankings
                        sortedCustomers.forEach((customer, index) => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td style="border: 1px solid #4CAF50; padding: 8px;">${index + 1}</td>
                                <td style="border: 1px solid #4CAF50; padding: 8px;">${customer.name}</td>
                                <td style="border: 1px solid #4CAF50; padding: 8px;">${customer.frequency}</td>
                            `;
                            rankingTableBody.appendChild(row);
                        });
                    }
                }

                // Call updateCustomerRanking when page loads and when client data changes
                window.addEventListener('load', updateCustomerRanking);
                document.addEventListener('clientDataChanged', updateCustomerRanking);
            </script>
            <script>
                // Load client data when page loads
                window.addEventListener('load', loadClientData);

                // Handle form submission
                document.getElementById('clientForm').addEventListener('submit', function(event) {
                    event.preventDefault();
                    const formData = new FormData(event.target);

                    const pickupDate = formData.get('pickupDate');
                    const returnDate = formData.get('returnDate');
                    const pricePerDay = parseFloat(formData.get('pricePerDay'));

                    // Calculate total price
                    const paymentStatus = 'paid';
                    let totalPrice;
                    if (paymentStatus === 'not-paid') {
                        totalPrice = 0;
                    } else {
                        const timeDiff = new Date(returnDate) - new Date(pickupDate);
                        const daysRented = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        totalPrice = daysRented * pricePerDay;
                    }

                    // Create client data object
                    const clientData = {
                        fullName: formData.get('fullName'),
                        clientID: formData.get('clientID'),
                        phoneNumber: formData.get('phoneNumber'),
                        vehicleModel: formData.get('vehicleModel'),
                        vehiclePlate: formData.get('vehiclePlate'),
                        pickupDate: pickupDate,
                        returnDate: returnDate,
                        pricePerDay: pricePerDay,
                        totalPrice: totalPrice,
                        status: 'Not Returned',
                        paymentStatus: paymentStatus
                    };

                    // Save to localStorage
                    saveClientData(clientData);

                    // Create and add new row
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>${clientData.fullName}</td>
                        <td>${clientData.clientID}</td>
                        <td>${clientData.phoneNumber}</td>
                        <td>${clientData.vehicleModel}</td>
                        <td>${clientData.vehiclePlate}</td>
                        <td>${clientData.pickupDate}</td>
                        <td><input type="date" value="${clientData.returnDate}" /></td>
                        <td>${formatNumberWithCommas(clientData.pricePerDay)} KMF</td>
                        <td>${formatNumberWithCommas(clientData.totalPrice)} KMF</td>
                        <td><span class="status">${clientData.status}</span></td>
                        <td><select class='payment-status'>
                            <option value='paid' selected>Paid</option>
                            <option value='not-paid'>Not Paid</option>
                        </select></td>
                        <td class="delete-column">
                            <button class="deleteBtn" style="background-color: red; color: white; border: none; border-radius: 5px; cursor: pointer;">Delete</button>
                        </td>
                    `;

                    // Add event listeners to the new row
                    addRowEventListeners(newRow, clientData);

                    // Add highlighting if needed
                    if (clientData.status === 'Not Returned') {
                        newRow.classList.add('highlight');
                    }

                    // Add to table
                    const clientTableBody = document.querySelector('#statistics table.client tbody');
                    clientTableBody.prepend(newRow);

                    // Clear form
                    event.target.reset();

                    // Update calculations
                    updateTotalIncome();
                    calculateMonthlyIncome();
                    calculateCustomerRanking();
                });
            </script>
            <script>
                // Function to save expense data to localStorage
                function saveExpenseData(expenseData) {
                    localStorage.setItem('expenseData', JSON.stringify(expenseData));
                }

                // Function to load expense data from localStorage
                function loadExpenseData() {
                    const expenseData = JSON.parse(localStorage.getItem('expenseData')) || [];
                    const tbody = document.querySelector('#expenseTable tbody');
                    tbody.innerHTML = '';
                    let total = 0;

                    expenseData.forEach(expense => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${expense.date}</td>
                            <td>${expense.motif}</td>
                            <td>${expense.comment}</td>
                            <td>${expense.price.toLocaleString('en-US')} KMF</td>
                            <td><button onclick="deleteExpenseRow(this)" style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">Delete</button></td>
                        `;
                        total += expense.price;
                    });

                    document.getElementById('totalExpense').innerText = total.toLocaleString('en-US') + ' KMF';
                    updateTotalRestant();
                }

                // Function to delete expense row
                function deleteExpenseRow(button) {
                    const row = button.parentNode.parentNode;
                    const tbody = row.parentNode;
                    const expenseData = JSON.parse(localStorage.getItem('expenseData')) || [];
                    
                    // Remove the expense from the array
                    expenseData.splice(row.rowIndex - 1, 1);
                    
                    // Save updated data
                    saveExpenseData(expenseData);
                    
                    // Remove row from table
                    tbody.removeChild(row);
                    
                    // Update totals
                    updateTotalExpense();
                    updateTotalRestant();
                }

                document.getElementById('addExpenseButton').onclick = function() {
                    var date = document.getElementById('expenseDate').value;
                    var motif = document.getElementById('expenseMotif').value;
                    var comment = document.getElementById('expenseComment').value;
                    var price = parseFloat(document.getElementById('expensePrice').value);

                    if (!date || !motif || !price) {
                        alert('Please fill in all required fields (Date, Motif, and Price)');
                        return;
                    }

                    var table = document.getElementById('expenseTable').getElementsByTagName('tbody')[0];
                    var row = table.insertRow();
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${motif}</td>
                        <td>${comment}</td>
                        <td>${price.toLocaleString('en-US')} KMF</td>
                        <td><button onclick="deleteExpenseRow(this)" style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">Delete</button></td>
                    `;
                    
                    // Save to localStorage
                    const expenseData = JSON.parse(localStorage.getItem('expenseData')) || [];
                    expenseData.push({ date, motif, comment, price });
                    saveExpenseData(expenseData);

                    // Clear form
                    document.getElementById('expenseDate').value = '';
                    document.getElementById('expenseMotif').value = '';
                    document.getElementById('expenseComment').value = '';
                    document.getElementById('expensePrice').value = '';

                    // Update totals
                    updateTotalExpense();
                    updateTotalRestant();
                };

                // Load expense data when page loads
                window.addEventListener('load', loadExpenseData);
            </script>
            <script>
                // Function to save balance data to localStorage
                function saveBalanceData(balanceData) {
                    const existingData = JSON.parse(localStorage.getItem('balanceData')) || [];
                    existingData.push(balanceData);
                    localStorage.setItem('balanceData', JSON.stringify(existingData));
                }

                // Function to load balance data from localStorage
                function loadBalanceData() {
                    const balanceData = JSON.parse(localStorage.getItem('balanceData')) || [];
                    const tableBody = document.getElementById('balanceAddTableBody');
                    
                    tableBody.innerHTML = ''; // Clear existing rows

                    balanceData.forEach(data => {
                        const row = document.createElement('tr');
                        row.setAttribute('data-id', data.id);
                        row.innerHTML = `
                            <td style="border: 1px solid #dee2e6; padding: 12px;">${data.date}</td>
                            <td style="border: 1px solid #dee2e6; padding: 12px;">${data.motif}</td>
                            <td style="border: 1px solid #dee2e6; padding: 12px;">${data.comment}</td>
                            <td style="border: 1px solid #dee2e6; padding: 12px;">${formatNumberWithCommas(data.balance)} KMF</td>
                            <td style="border: 1px solid #dee2e6; padding: 12px;">
                                <button onclick="deleteBalanceRow(this)" class="delete-btn" style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">Delete</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });

                    // Update total restant after loading balance data
                    updateTotalRestant();
                }

                // Function to delete balance row
                function deleteBalanceRow(button) {
                    if (confirm('Are you sure you want to delete this balance entry?')) {
                        const row = button.closest('tr');
                        const rowId = row.getAttribute('data-id');
                        
                        // Remove from localStorage
                        const balanceData = JSON.parse(localStorage.getItem('balanceData')) || [];
                        const updatedBalanceData = balanceData.filter(item => item.id !== parseInt(rowId));
                        localStorage.setItem('balanceData', JSON.stringify(updatedBalanceData));
                        
                        // Remove row from table
                        row.remove();
                        
                        // Update total restant
                        updateTotalRestant();
                    }
                }

                // Load balance data when page loads
                window.addEventListener('load', loadBalanceData);
            </script>
            <script>
                // Function to calculate total balance from Balance Table
                function calculateTotalBalance() {
                    let totalBalance = 0;
                    const balanceRows = document.querySelectorAll('#balanceAddTableBody tr');
                    
                    balanceRows.forEach(row => {
                        const balanceText = row.cells[3].textContent;
                        const balance = parseFloat(balanceText.replace(/[^\d.-]/g, '')); // Remove non-numeric characters except decimal and negative
                        if (!isNaN(balance)) {
                            totalBalance += balance;
                        }
                    });
                    
                    return totalBalance;
                }

                // Modified updateTotalRestant function to include balance
                function updateTotalRestant() {
                    const totalIncome = parseFloat(document.getElementById('totalIncome').innerText.replace(/ KMF/, '').replace(/,/g, ''));
                    const totalExpense = parseFloat(document.getElementById('totalExpense').innerText.replace(/ KMF/, '').replace(/,/g, ''));
                    const totalBalance = calculateTotalBalance();
                    
                    const totalRestant = totalIncome - totalExpense + totalBalance;
                    document.getElementById('summaryTotalRestant').innerText = totalRestant.toLocaleString('en-US') + ' KMF';
                }

                // Update the Balance Add form submission to call updateTotalRestant
                document.getElementById('balanceAddForm').addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    // Get form values
                    const date = document.getElementById('balanceDate').value;
                    const motif = document.getElementById('balanceMotif').value;
                    const comment = document.getElementById('balanceComment').value;
                    const balance = document.getElementById('balanceAmount').value;
                    
                    // Create new table row
                    const tableBody = document.getElementById('balanceAddTableBody');
                    const newRow = document.createElement('tr');
                    const timestamp = new Date().getTime();
                    newRow.setAttribute('data-id', timestamp);
                    newRow.innerHTML = `
                        <td style="border: 1px solid #dee2e6; padding: 12px;">${date}</td>
                        <td style="border: 1px solid #dee2e6; padding: 12px;">${motif}</td>
                        <td style="border: 1px solid #dee2e6; padding: 12px;">${comment}</td>
                        <td style="border: 1px solid #dee2e6; padding: 12px;">${formatNumberWithCommas(balance)} KMF</td>
                        <td style="border: 1px solid #dee2e6; padding: 12px;">
                            <button onclick="deleteBalanceRow(this)" class="delete-btn" style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">Delete</button>
                        </td>
                    `;
                    
                    // Add new row to table
                    tableBody.appendChild(newRow);
                    
                    // Save to localStorage
                    const balanceData = {
                        id: timestamp,
                        date,
                        motif,
                        comment,
                        balance: parseFloat(balance)
                    };
                    saveBalanceData(balanceData);
                    
                    // Clear form
                    this.reset();
                    
                    // Update total restant
                    updateTotalRestant();
                });

                // Modify the deleteBalanceRow function to update total restant
                function deleteBalanceRow(button) {
                    if (confirm('Are you sure you want to delete this balance entry?')) {
                        const row = button.closest('tr');
                        const rowId = row.getAttribute('data-id');
                        
                        // Remove from localStorage
                        const balanceData = JSON.parse(localStorage.getItem('balanceData')) || [];
                        const updatedBalanceData = balanceData.filter(item => item.id !== parseInt(rowId));
                        localStorage.setItem('balanceData', JSON.stringify(updatedBalanceData));
                        
                        // Remove row from table
                        row.remove();
                        
                        // Update total restant
                        updateTotalRestant();
                    }
                }

                // Auto-fill comment for Balance precedent
                document.getElementById('balanceMotif').addEventListener('change', function() {
                    const commentInput = document.getElementById('balanceComment');
                    if (this.value === 'Balance precedent') {
                        // Get yesterday's date
                        const today = new Date();
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        
                        // Format the date as DD/MM/YYYY
                        const day = String(yesterday.getDate()).padStart(2, '0');
                        const month = String(yesterday.getMonth() + 1).padStart(2, '0');
                        const year = yesterday.getFullYear();
                        
                        // Set the comment
                        commentInput.value = `Balance Restant du ${day}/${month}/${year}`;
                        commentInput.placeholder = "Comment";
                    } else if (this.value === 'Emprunt d\'argent') {
                        commentInput.value = '';
                        commentInput.placeholder = "Enter Name";
                    } else {
                        // Clear the comment if any other motif is selected
                        commentInput.value = '';
                        commentInput.placeholder = "Comment";
                    }
                });
            </script>
            <script>
                // Function to clear all data
                function clearAllData() {
                    if (confirm('Are you sure you want to clear all data? This will remove all clients, balances, and expenses. This action cannot be undone.')) {
                        // Clear localStorage
                        localStorage.clear();
                        
                        // Clear all tables
                        document.getElementById('balanceAddTableBody').innerHTML = '';
                        document.querySelector('.client tbody').innerHTML = '';
                        document.querySelector('#expenseTable tbody').innerHTML = '';
                        
                        // Reset total income
                        document.getElementById('totalIncome').textContent = '0 KMF';
                        
                        // Refresh the page to reset all states
                        window.location.reload();
                    }
                }
            </script>
            <script>
                // Print functionality
                function printPage() {
                    // Get current date and format it
                    const currentDate = new Date('2025-01-14T11:58:39+03:00');
                    const formattedDate = currentDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    // Update the printed date
                    document.getElementById('printedDate').innerText = formattedDate;

                    // Hide the print and delete buttons before printing
                    const deleteButtons = document.querySelectorAll('.deleteBtn, .delete-btn');
                    deleteButtons.forEach(button => {
                        button.style.display = 'none';
                    });

                    // Hide any other elements you don't want to print
                    const nonPrintableElements = document.querySelectorAll('.non-printable');
                    nonPrintableElements.forEach(element => {
                        element.style.display = 'none';
                    });

                    // Print the page
                    window.print();

                    // Restore the buttons after printing
                    deleteButtons.forEach(button => {
                        button.style.display = 'block';
                    });

                    // Restore other hidden elements
                    nonPrintableElements.forEach(element => {
                        element.style.display = '';
                    });
                }

                document.getElementById('printButton').onclick = null;
                document.getElementById('printButton').addEventListener('click', printPage);
            </script>
            <script>
                // Function to update customer ranking table
                function updateCustomerRanking() {
                    const clientData = JSON.parse(localStorage.getItem('clientData')) || [];
                    const customerFrequency = {};
                    
                    // Count rental frequency for each customer
                    clientData.forEach(client => {
                        const fullName = client.fullName;
                        if (fullName) { // Make sure we have a valid name
                            customerFrequency[fullName] = (customerFrequency[fullName] || 0) + 1;
                        }
                    });

                    // Convert to array and sort by frequency
                    const sortedCustomers = Object.entries(customerFrequency)
                        .map(([name, frequency]) => ({ name, frequency }))
                        .sort((a, b) => b.frequency - a.frequency);

                    // Update the table
                    const rankingTableBody = document.getElementById('customerRankingBody');
                    rankingTableBody.innerHTML = ''; // Clear existing rows

                    if (sortedCustomers.length === 0) {
                        // If no customers, show a message
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="3" style="border: 1px solid #4CAF50; padding: 8px; text-align: center;">No customer data available</td>
                        `;
                        rankingTableBody.appendChild(row);
                    } else {
                        // Show customer rankings
                        sortedCustomers.forEach((customer, index) => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td style="border: 1px solid #4CAF50; padding: 8px;">${index + 1}</td>
                                <td style="border: 1px solid #4CAF50; padding: 8px;">${customer.name}</td>
                                <td style="border: 1px solid #4CAF50; padding: 8px;">${customer.frequency}</td>
                            `;
                            rankingTableBody.appendChild(row);
                        });
                    }
                }

                // Call updateCustomerRanking when page loads and when client data changes
                window.addEventListener('load', updateCustomerRanking);
                document.addEventListener('clientDataChanged', updateCustomerRanking);
            </script>
        </section>
    </main>
</body>
</html>